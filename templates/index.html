<!-- templates/index.html -->
{% extends "layout.html" %}
{% block content %}
    <div style="display: flex; flex-direction: column; align-items: center;">
        <h1>Chess AI Data Collector</h1>
        <div id="myBoard" style="width: 400px"></div>
        <p>Status: <span id="status"></span></p>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
        // This is the same interactive chess JS from the previous step.
        // It does not need to be changed.
        $(function () {
          var board = null;
          var game = new Chess();
          var statusEl = $('#status');

          function onDragStart(source, piece) {
            if (game.game_over() || (game.turn() === 'b')) return false;
          }

          function onDrop(source, target) {
            var move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            makeAIMove(source + target);
          }

          function onSnapEnd() { board.position(game.fen()); }

          function makeAIMove(playerMoveUci) {
            statusEl.html('AI is thinking...');
            fetch('/move', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ move: playerMoveUci })
            })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'Success' || (data.status === 'Game Over' && data.ai_move)) {
                game.move(data.ai_move, { sloppy: true });
                board.position(game.fen());
              }
              updateStatus();
            });
          }

          function updateStatus() {
            var moveColor = game.turn() === 'b' ? 'Black' : 'White';
            var status = game.in_checkmate() ? 'Game over, ' + moveColor + ' is in checkmate.' :
                         game.in_draw() ? 'Game over, drawn position.' :
                         moveColor + ' to move.';
            if (game.in_check()) status += ', ' + moveColor + ' is in check.';
            statusEl.html(status);
          }
          
          var config = {
            draggable: true,
            position: 'start',
            pieceTheme: '/static/pieces/{piece}.png',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd
          };
          board = Chessboard('myBoard', config);
          updateStatus();
        });
    </script>
{% endblock %}